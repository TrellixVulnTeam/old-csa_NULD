# @explorelearning/platform-data

A javascript package providing a data layer for apps, including vuex integration

## Install the package and dependencies

In your project's root directoy, run this command to install the `platform-data` package and all of its peer dependencies:

```bash
npm i -S @explorelearning/platform-data@latest \
  @explorelearning/platform-rest-api@latest \
  @explorelearning/base-api@latest \
  @explorelearning/el-authenticator@latest \
  @explorelearning/urls@latest \
  @explorelearning/utils@latest \
  axios@0.21
```

## Register the package in your app

In the `src/main.js` file (or wherever your Vue app is instantiated), you must create a `PlaformData.State` object and then register it with your app's vuex store:

```js
// src/main.js
import Vue from 'vue';
import Vuex from 'vuex';
import PlatformData from '@explorelearning/platform-data';
import urls from '@explorelearning/urls';
import App from './App.vue';

const platState = new PlatformData.State({
  endpoints: {
    auth: `${urls.getUrls().services}/reflex/auth/claims`,
    login: process.env.VUE_APP_LOGIN_URL,
    logout: process.env.VUE_APP_LOGOUT_URL
  }
});
platState.register(store);

new Vue({
  el: '#app',
  store,
  render: (h) => h(App)
})
```

The values of the three `endpoints` properties need to be set specific to the app's context:

- `auth`: whatever platform app endpoint is used to check whether or not the user is authenticated
- `login`: the url a user will be sent to if they need to log in
- `logout`: the url a user will go to when they log out (might be the same as the `login`)

See the [`README.md` for `@explorelearning/urls`](https://github.com/ExploreLearning/el-web/tree/main/packages/urls) for more info on that package.

---

After the `PlatformData.State` is registered, the app will have access to the actions, mutations, getters, and state of the modules found in the `./src/state/` folder:

- `app`
- `classes`
- `employee`
- `profile`
- `students`
- `teachers`

See the comments in those files for more information on their functionality.

Each module is namespaced to their filename and a root namespace (`'platform'` by default). So, for example, if you wanted to call the `fetchModel` action in the `app` module, you would need to access the namespaced action like so:

```js
this.$store.dispatch('platform/app/fetchModel');
```

## Example Usage in a Component

Here, the `profile` getter and the `initApp` action are mapped from their associated namespace to the component so that the component has access to them both via `this.profile` and `this.initApp`.

```html
// src/App.vue
<template>
  <div id="app">
    <div v-if="loaded">
      {{ profile }}
    </div>
  </div>
</template>

<script>
import { mapGetters, mapActions } from 'vuex';

export default {
  data() {
    return {
      loaded: false
    }
  },
  computed: {
    ...mapGetters('platform/profile', ['profile'])
  },
  methods: {
    ...mapActions('platform/app', ['initApp'])
  },
  async mounted() {
    // this will only work if you're already logged into the platform
    await this.initApp()
    this.loaded = true;
  }
}
</script>
```

## Authenticating

The above example assumed that the user's session was already authenticated. By default, the user will be sent to the logout url specified in the `endpoints` param object if they are not authenticated and any protected platform api endpoints are called.

If you want the user to be able to authenticate from the app itself (useful for local development), you'll need to handle the case where the app loads on its login view which should always be accessible.

Here's an example of an `App.vue` file that checks for authentication and handles it

```html
// src/App.vue
<template>
  <div id="app">
    <router-view v-if="loaded"/>
  </div>
</template>

<script>
import { mapState, mapActions } from 'vuex';

export default {
  data() {
    return {
      loaded: false,
      loginUrl: process.env.VUE_APP_LOGIN_URL // this might be a relative link pointing to a login view in the app, or to another locally running app
    };
  },
  computed: {
    ...mapState('platform/app', ['jti'])
  },
  methods: {
    ...mapActions('platform/app', ['initApi', 'initApp', 'fetchModel']),
    async init() {
      await this.initApp();
      await this.fetchModel();
    }
  },
  async mounted() {
    // if we can init the api and get a valid jti token, then the user is logged in, so init the app
    await this.initApi({ logout: false }); // don't logout if this call is made without authentication
    if (this.jti) await this.init();
    else window.location = `${this.loginUrl}?f=${encodeURIComponent(window.location)}`;
    this.loaded = true;
  }
};
</script>
```

And here is a simple example of a component which could be used for the login route:

```html
<template>
  <form @submit.prevent="loginUser">
    <input v-model="username" placeholder="username"/>
    <input v-model="password" type="password" placeholder="password"/>
    <button type="submit">Login</button>
  </form>
</template>

<script>
import { mapActions } from 'vuex';

export default {
  data() {
    return {
      username: '',
      password: ''
    };
  },
  methods: {
    ...mapActions('platform/app', ['login']),
    async loginUser() {
      const { username, password } = this;
      try {
        await this.login({ username, password, url: process.env.VUE_APP_AUTH_ENDPOINT });
        this.$router.push('/');
      } catch (e) {
        alert(e.message);
      }
    }
  }
};
</script>
```

## Lookup Object

The package also exports a [`Lookup` object](./src/utils/Lookup.ts) containing mappings from names of common EL Platform / Product items to their associated ids:

```js
import { Lookup } from '@explorelearning/platform-data';

// Find the item name by id
Lookup.product[1]; // 'reflex'
Lookup.role[2]; // 'Student'
Lookup.grade[7]; // 'Grade 6'

// Or find the associated id by item name
Lookup.inverse.product.reflex; // 1
Lookup.inverse.role.Student; // 2
Lookup.inverse.grade['Grade 6']; // 7
```
