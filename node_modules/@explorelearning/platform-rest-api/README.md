# @explorelearning/platform-rest-api

A javascript library for interacting with the EL Platform API on the backend.

## Usage

```bash
npm i -S @explorelearning/platform-rest-api
```

```javascript
// import the ElAuthenticator along with this package
import ElAuthenticator from '@explorelearning/el-authenticator';
import ElPlatformRestApi from '@explorelearning/platform-rest-api';

const platformUrl = 'https://platform.elmydev.net/platform-rest/'
const accountsUrl = 'https://elmydev.net/login/reflex/'

// instantiate an authenticator for the platform api to use
const auth = new ElAuthenticator({
  auth: platformUrl + 'auth/claims/admin',
  login: accountsUrl + 'teacher',
  logout: accountsUrl + 'logout',
  refresh: platformUrl + '/api/refresh',
  logging: platformUrl + '/clientLog'
});

// specify handler functions for response error codes
const errorCodeHandlers = {
  '403'() { // if bad permissions, send the user home
    locations.href = "/reporting/";
  }
}

// instantiate the api class
const platform = new ElPlatformRestApi({
  baseURL: platformUrl + '/api/platform',
  auth,
  errorCodeHandlers
});

// now use the platform api to communicate with the backend
(async function() {
  // You'll need to first authenticate in order retrieve data from the backend
  if (GlobalClaims) {
    // if you already have a reference to the claims object returned by the auth api, then you can give that value directly to the `Authenticator` instance
    auth.setClaims(GlobalClaims);
  } else {
    // otherwise, the `Authenticator` instance has its own method to authenticate the client
    await auth.authenticate();
  }

  const tenantId = 1000;
  const institutionId = 1234;
  const subscriptionId = 4321;

  // pull down the model, specifying the institution ID and subscription ID
  const model = await platform.fetchModel({ institutionId, subscriptionId });
  const { users, institutions, subscriptions } = model;
  const { students, teachers, administrators } = users;

  // update multiple users in the model
  const firstTeacher = teachers[0];
  const secondTeacher = teachers[1];
  await platform.updateUsers({
    tenantId,
    institutionId,
    users: [
      { ...firstTeacher, middleName: 'Alvin' },
      { ...secondTeacher, lastName: 'Putnam' }
    ]
  });

  // create a new user
  const userId = await platform.createUser({
    tenantId,
    roleId: 5,
    username: 'admin',
    firstName: 'Admin',
    middleName: '',
    lastName: 'User',
    titleId: 1,
    email: 'admin.user@explorelearning.com',
    sisUserId: 'abc123',
    languageId: 1,
    isValidEmail: true,
    isSubscribedToEmails: false
  });
})();

```

## Available methods

The following methods have been ported over from the reporting app:

- `fetchModel`
- `fetchSeatCount`
- `fetchRegCodes`
- `createRegCode`
- `setRegCodeUses`
- `sendRegCodeEmail`
- `sendConfirmationEmail`
- `createUser`
- `updateUsers`
- `deleteUsers`
- `createClass`
- `updateClass`
- `deleteClass`
- `addStudentsToClass`
- `removeStudentsFromClass`
- `addTeachersToClass`
- `removeTeachersFromClass`
- `fetchStudentsById`
- `fetchStudentsByInstitution`
- `fetchTeachersByInstitution`
- `updateInstitution`
- `fetchProfile`
- `updateProfile`
- `createStudents`
- `updateStudents`
- `deleteStudents`
- `transferStudents`
- `addStudentToParent`
- `removeStudentFromParent`
- `addStudentsToProduct`
- `removeStudentsFromProduct`

## Areas for improvement

### Actionable

- [ ] Make sure all responses are formatted the same as the model call and that methods take in data in the same format
- [ ] Autogenerated docs
- [ ] Use enums for all the different id types
- [ ] Add types for raw response data
- [ ] See if we can initialize the api with some static ids (`tenantId`, ?, etc.)
- [ ] Move the `serialize` method to utils
- [ ] Allow option to return raw response data
- [ ] Figure out why typescript isn't recognizing the inherited `api` property from the ELBaseApi

### Would need to work with backend

- A few calls need a `subscriptionID` and `productID`, but shouldn't the backend know the `productID` based on the subscription?
- We don't have a bulk endpoint for updating users, which could cut down on requests.
- Why do we need to send the `isValidEmail` property? Will the frontend ever know that?
- Student logins probably don't need the `isValidEmail` or `isSubscribedToEmails` properties in their response objects.
- Does the class response object need to include `memberID` or `assignmentInfo`? We don't use it in the reporting app. We get `memberID` for the institution response object as well.
- We should be able to send `PATCH` requests to update entities so that we don't need to manage extraneous data.
- Are we going to be able to get an `institutionID` from the model call? Currently we don't and if the model call is made without passing `institutionID` as a param, the client might not know what the associated `institutionID` is for the model
- Why do we need to specify an `institutionID` when deleting users / classes?
- Is it still the case that classes might have student ids that aren't in the model? We're currently having to check that for every model call.
- If we could specify `teacherIds` in the requests for creating / updating a class, the frontend wouldn't need to make extra calls to add / remove teachers.
- Are classes going to need a `productId` specified anymore? Or will classes be product-agnostic?
- Why do we need to pass the `institutionId` in the request for adding / removing students to / from a class, but we don't for teachers?
- Can the add / remove product requests respond with the newly updated student? Right now we have to update the student objects on the frontend to reflect the change that has happened on the backend.
- Why do we not always get the profile info when students are created? We currently have to make a call to retrieve all students in the institution if we aren't provided that info
